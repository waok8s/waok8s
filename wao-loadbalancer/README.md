# WAO Load Balancer Version 2

A kube-proxy with energy-aware load balancing feature.

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [Overview](#overview)
- [Getting Started](#getting-started)
  - [Installation](#installation)
  - [Deploy Services](#deploy-services)
  - [Check Current Weights](#check-current-weights)
- [Configuration](#configuration)
- [Development](#development)
  - [Components](#components)
- [Changelog](#changelog)
- [Acknowledgements](#acknowledgements)
- [License](#license)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Overview

WAO Load Balancer is a custom kube-proxy that uses WAO to achieve energy-aware load balancing. Calculating the weight of each node based on the power consumption model, then updating the weight of the node in the kube-proxy implementation. Only kube-proxy in `nftables` mode is supported.

> [!NOTE]
> We previously supported `ipvs` mode, but it is now removed.

## Getting Started

### Installation

> [!NOTE]
> Make sure you have [wao-core](https://github.com/waok8s/wao-core) and [wao-metrics-adapter](https://github.com/waok8s/wao-metrics-adapter) set up.


1. Ensure kube-proxy is running in nftables mode.
2. Replace the container image of kube-proxy with our custom image.

### Deploy Services

TBD

### Check Current Weights

TBD

## Configuration

TBD

## Development

> [!WARNING]
> Do not edit the files in `cmd` and `pkg`, as they are generated by the build scripts.
> Instead, modify the files in `_src` and follow the build steps.

- Each kube-proxy mode has its own implementation, and we modify them to use WAO.
- The modified files are located in `_src` directory.
  - If you want to change the implementation, modify the files in `_src` and follow the build steps.
- Build scripts are provided in `hack` directory.
  - `build-01-copy-k8s-code.sh` copies the related files to `cmd` and `pkg` directories. 
  - `build-02-apply-patches.sh` overwrites the original files with the modified files in `_src`.
- After the preparation, you can just run `make build` to build the kube-proxy.

### Components

- See `_src/README.md` for details.

## Changelog

Versioning: we use the same major.minor as Kubernetes, and the patch is our own.

- 2025-xx-xx `v1.30.0-alpha.1`
  - Drop support for `ipvs` mode (now only `nftables` mode is supported).
  - Internal improvements.
  - TBD
- 2025-02-05 `v1.30.0-alpha.0`
  - Support both `ipvs` and `nftables` mode.
  - Now the container image is available.
- 2024-07-01 `v1.29.0-alpha.0`
  - Support both `ipvs` and `nftables` mode.
  - You need to build the image by yourself.

## Acknowledgements

This work is supported by the New Energy and Industrial Technology Development Organization (NEDO) under its "Program to Develop and Promote the Commercialization of Energy Conservation Technologies to Realize a Decarbonized Society" ([JPNP21005](https://www.nedo.go.jp/english/activities/activities_ZZJP_100197.html)).

## License

> [!NOTE]
> The original Kubernetes code is [licensed under Apache-2.0](https://github.com/kubernetes/kubernetes/blob/master/LICENSE).

Copyright 2021 Osaka University.  
Copyright 2022 Bitmedia, Inc.  
Copyright 2024 Neutrix Cloud Japan Corporation.  
Copyright 2025 Bitmedia, Inc.  

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
